import React, { useState, useEffect } from "react";
import {
    View,
    Text,
    StyleSheet,
    TouchableOpacity,
    StatusBar,
    Alert,
    Dimensions,
    Animated,
    ScrollView,
} from "react-native";
import { LinearGradient } from "expo-linear-gradient";
import { Ionicons } from "@expo/vector-icons";
import { SafeAreaView } from "react-native-safe-area-context";
import * as Clipboard from 'expo-clipboard';
import { CameraView, CameraType, useCameraPermissions, Camera } from 'expo-camera';
import { Audio } from 'expo-av';
import * as MediaLibrary from 'expo-media-library';
import { colors, spacing, radius, elevation, typography } from "../../design/tokens";
import { useCameraConnection } from "../../hooks/useCameraConnection";
import { webrtcService } from '../../services/webrtcService';
import { forceRediscover, testConnection } from '../../config';
import { simpleNetworkDiscovery } from '../../services/simpleNetworkDiscovery';

const { width: screenWidth, height: screenHeight } = Dimensions.get('window');

interface CameraHomeScreenProps {
    navigation?: any;
}

export default function CameraHomeScreen({ navigation }: CameraHomeScreenProps) {
    // Ïπ¥Î©îÎùº ID ÏÉùÏÑ±
    const cameraId = `MIMO_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    const cameraName = 'ÌôàÏ∫†';

    const [connectionState, connectionActions] = useCameraConnection(cameraId, cameraName);
    const [isStreaming, setIsStreaming] = useState(false);
    const [streamingViewer, setStreamingViewer] = useState<string | null>(null);
    const [pinCode, setPinCode] = useState<string | null>(null);
    const [webRTCStream, setWebRTCStream] = useState<any>(null);
    const [streamingStatus, setStreamingStatus] = useState<'idle' | 'connecting' | 'streaming' | 'error'>('idle');
    const [cameraType, setCameraType] = useState<CameraType>('back');
    const [permission, requestPermission] = useCameraPermissions();
    const [hasAllPermissions, setHasAllPermissions] = useState(false);
    const [isRequestingPermissions, setIsRequestingPermissions] = useState(false);

    // Ïï†ÎãàÎ©îÏù¥ÏÖò Í∞íÎì§
    const [fadeAnim] = useState(new Animated.Value(0));
    const [slideAnim] = useState(new Animated.Value(50));
    const [scaleAnim] = useState(new Animated.Value(0.95));
    const [pinPulseAnim] = useState(new Animated.Value(1));

    useEffect(() => {
        // ÌôîÎ©¥ ÏßÑÏûÖ Ïï†ÎãàÎ©îÏù¥ÏÖò
        Animated.parallel([
            Animated.timing(fadeAnim, {
                toValue: 1,
                duration: 800,
                useNativeDriver: true,
            }),
            Animated.timing(slideAnim, {
                toValue: 0,
                duration: 800,
                useNativeDriver: true,
            }),
            Animated.timing(scaleAnim, {
                toValue: 1,
                duration: 800,
                useNativeDriver: true,
            }),
        ]).start();
    }, []);

    // PIN ÏΩîÎìúÍ∞Ä ÏÉùÏÑ±ÎêòÎ©¥ ÌéÑÏä§ Ïï†ÎãàÎ©îÏù¥ÏÖò
    useEffect(() => {
        if (pinCode) {
            Animated.loop(
                Animated.sequence([
                    Animated.timing(pinPulseAnim, {
                        toValue: 1.05,
                        duration: 2000,
                        useNativeDriver: true,
                    }),
                    Animated.timing(pinPulseAnim, {
                        toValue: 1,
                        duration: 2000,
                        useNativeDriver: true,
                    }),
                ])
            ).start();
        }
    }, [pinCode]);

    // Í∂åÌïú ÏöîÏ≤≠ Ìï®Ïàò
    const requestAllPermissions = async () => {
        if (isRequestingPermissions) return;

        setIsRequestingPermissions(true);

        try {
            console.log('üîê Í∂åÌïú ÏöîÏ≤≠ ÏãúÏûë...');

            // Ïπ¥Î©îÎùº Í∂åÌïú
            const cameraPermission = await Camera.requestCameraPermissionsAsync();
            console.log('üì∑ Ïπ¥Î©îÎùº Í∂åÌïú:', cameraPermission.status);

            // Ïò§ÎîîÏò§ Í∂åÌïú
            const audioPermission = await Audio.requestPermissionsAsync();
            console.log('üé§ Ïò§ÎîîÏò§ Í∂åÌïú:', audioPermission.status);

            // ÎØ∏ÎîîÏñ¥ ÎùºÏù¥Î∏åÎü¨Î¶¨ Í∂åÌïú
            const mediaPermission = await MediaLibrary.requestPermissionsAsync();
            console.log('üíæ ÎØ∏ÎîîÏñ¥ ÎùºÏù¥Î∏åÎü¨Î¶¨ Í∂åÌïú:', mediaPermission.status);

            const allGranted =
                cameraPermission.status === "granted" &&
                audioPermission.status === "granted" &&
                mediaPermission.status === "granted";

            if (allGranted) {
                console.log('‚úÖ Î™®Îì† Í∂åÌïúÏù¥ ÌóàÏö©ÎêòÏóàÏäµÎãàÎã§!');
                setHasAllPermissions(true);

                // Í∂åÌïú ÌóàÏö© Ïãú Î∂ÄÎìúÎü¨Ïö¥ Ï†ÑÌôò Ïï†ÎãàÎ©îÏù¥ÏÖò
                Animated.sequence([
                    Animated.timing(scaleAnim, {
                        toValue: 1.1,
                        duration: 200,
                        useNativeDriver: true,
                    }),
                    Animated.timing(scaleAnim, {
                        toValue: 1,
                        duration: 300,
                        useNativeDriver: true,
                    }),
                ]).start();

                Alert.alert('ÏÑ±Í≥µ', 'Î™®Îì† Í∂åÌïúÏù¥ ÌóàÏö©ÎêòÏóàÏäµÎãàÎã§!');
            } else {
                console.log('‚ùå ÏùºÎ∂Ä Í∂åÌïúÏù¥ Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§');
                const deniedPermissions = [];
                if (cameraPermission.status !== "granted") deniedPermissions.push("Ïπ¥Î©îÎùº");
                if (audioPermission.status !== "granted") deniedPermissions.push("ÎßàÏù¥ÌÅ¨");
                if (mediaPermission.status !== "granted") deniedPermissions.push("Ï†ÄÏû•ÏÜå");

                Alert.alert(
                    'Í∂åÌïú ÌïÑÏöî',
                    `${deniedPermissions.join(", ")} Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.\nÏÑ§Ï†ïÏóêÏÑú Í∂åÌïúÏùÑ ÌóàÏö©Ìï¥Ï£ºÏÑ∏Ïöî.`,
                    [
                        {
                            text: 'ÏÑ§Ï†ïÏúºÎ°ú Ïù¥Îèô', onPress: () => {
                                // ÏÑ§Ï†ï Ïï±ÏúºÎ°ú Ïù¥ÎèôÌïòÎäî Î°úÏßÅ (ÌïÑÏöîÏãú Íµ¨ÌòÑ)
                            }
                        },
                        { text: 'Ï∑®ÏÜå', style: 'cancel' }
                    ]
                );
            }
        } catch (error) {
            console.error('‚ùå Í∂åÌïú ÏöîÏ≤≠ Ï§ë Ïò§Î•ò:', error);
            Alert.alert('Ïò§Î•ò', 'Í∂åÌïú ÏöîÏ≤≠ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
        } finally {
            setIsRequestingPermissions(false);
        }
    };

    // Ïπ¥Î©îÎùº Ï†ÑÌôò Ìï®Ïàò
    const toggleCameraType = () => {
        setCameraType(current => current === 'back' ? 'front' : 'back');
    };

    // Ïä§Ìä∏Î¶¨Î∞ç Í¥ÄÎ†® Ìï®ÏàòÎì§
    const startStreaming = async (viewerId: string) => {
        try {
            console.log(`üé• Ïä§Ìä∏Î¶¨Î∞ç ÏãúÏûë: ${cameraId} -> ${viewerId}`);

            const webRTCStream = await webrtcService.startStreaming(
                cameraId,
                viewerId
            );

            webRTCStream.onStreamReceived = (remoteStream) => {
                console.log('üì∫ ÏõêÍ≤© Ïä§Ìä∏Î¶º ÏàòÏã†Îê®');
            };

            setIsStreaming(true);
            setStreamingViewer(viewerId);

            Alert.alert('ÏÑ±Í≥µ', 'Ïä§Ìä∏Î¶¨Î∞çÏù¥ ÏãúÏûëÎêòÏóàÏäµÎãàÎã§!');
        } catch (error) {
            console.error('‚ùå Ïä§Ìä∏Î¶¨Î∞ç ÏãúÏûë Ïã§Ìå®:', error);
            Alert.alert('Ïò§Î•ò', 'Ïä§Ìä∏Î¶¨Î∞çÏùÑ ÏãúÏûëÌï† Ïàò ÏóÜÏäµÎãàÎã§.');
        }
    };

    const stopStreaming = async () => {
        try {
            if (streamingViewer && cameraId) {
                await webrtcService.stopStream(streamingViewer);
                setIsStreaming(false);
                setStreamingViewer(null);
                Alert.alert('ÏôÑÎ£å', 'Ïä§Ìä∏Î¶¨Î∞çÏù¥ Ï§ëÏßÄÎêòÏóàÏäµÎãàÎã§.');
            }
        } catch (error) {
            console.error('‚ùå Ïä§Ìä∏Î¶¨Î∞ç Ï§ëÏßÄ Ïã§Ìå®:', error);
        }
    };

    const handleToggleStreaming = async () => {
        if (isStreaming) {
            Alert.alert(
                "Ïä§Ìä∏Î¶¨Î∞ç Ï§ëÏßÄ",
                "Ïä§Ìä∏Î¶¨Î∞çÏùÑ Ï§ëÏßÄÌïòÏãúÍ≤†Ïñ¥Ïöî?",
                [
                    { text: "Ï∑®ÏÜå", style: "cancel" },
                    {
                        text: "Ï§ëÏßÄ",
                        style: "destructive",
                        onPress: async () => {
                            await stopStreaming();
                        },
                    },
                ]
            );
        } else {
            Alert.alert(
                "Ïä§Ìä∏Î¶¨Î∞ç ÏãúÏûë",
                "Ïä§Ìä∏Î¶¨Î∞çÏùÑ ÏãúÏûëÌïòÏãúÍ≤†Ïñ¥Ïöî?",
                [
                    { text: "Ï∑®ÏÜå", style: "cancel" },
                    {
                        text: "ÏãúÏûë",
                        style: "default",
                        onPress: async () => {
                            await startStreaming(cameraId);
                        },
                    },
                ]
            );
        }
    };

    const handleSettings = () => {
        navigation?.navigate("CameraSettings");
    };

    const handleGeneratePinCode = async () => {
        try {
            // PIN ÏΩîÎìú ÏÉùÏÑ±
            const generatedPin = await connectionActions.generatePinCode();
            setPinCode(generatedPin);

            Alert.alert(
                "Ïó∞Í≤∞ PIN ÏΩîÎìú",
                `Î∑∞Ïñ¥ÏóêÏÑú Îã§Ïùå PIN ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:\n\n${generatedPin}\n\nÏù¥ ÏΩîÎìúÎäî 10Î∂ÑÍ∞Ñ Ïú†Ìö®Ìï©ÎãàÎã§.`,
                [
                    {
                        text: "Î≥µÏÇ¨",
                        onPress: async () => {
                            try {
                                await Clipboard.setStringAsync(generatedPin);
                                Alert.alert("Î≥µÏÇ¨Îê®", "PIN ÏΩîÎìúÍ∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.");
                            } catch (error) {
                                Alert.alert("Ïò§Î•ò", "ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
                            }
                        }
                    },
                    { text: "ÌôïÏù∏", style: "default" }
                ]
            );
        } catch (error) {
            Alert.alert('Ïò§Î•ò', 'PIN ÏΩîÎìúÎ•º ÏÉùÏÑ±Ìï† Ïàò ÏóÜÏäµÎãàÎã§.');
        }
    };

    const renderPermissionScreen = () => (
        <Animated.View
            style={[
                styles.permissionContainer,
                {
                    opacity: fadeAnim,
                    transform: [
                        { translateY: slideAnim },
                        { scale: scaleAnim }
                    ]
                }
            ]}
        >
            <View style={styles.permissionCard}>
                <LinearGradient
                    colors={[colors.surface, colors.surfaceAlt]}
                    style={styles.permissionCardGradient}
                >
                    <View style={styles.permissionIconContainer}>
                        <LinearGradient
                            colors={[colors.primary, colors.accent]}
                            style={styles.permissionIconGradient}
                        >
                            <Ionicons name="camera" size={64} color={colors.surface} />
                        </LinearGradient>
                    </View>

                    <Text style={styles.permissionTitle}>Ïπ¥Î©îÎùº Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§</Text>
                    <Text style={styles.permissionDescription}>
                        ÌôàÏ∫† Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©ÌïòÎ†§Î©¥ Îã§Ïùå Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§:
                    </Text>

                    <View style={styles.permissionList}>
                        <View style={styles.permissionItem}>
                            <Ionicons name="camera" size={20} color={colors.primary} />
                            <Text style={styles.permissionItemText}>Ïπ¥Î©îÎùº - ÏòÅÏÉÅ Ï¥¨ÏòÅ</Text>
                        </View>
                        <View style={styles.permissionItem}>
                            <Ionicons name="mic" size={20} color={colors.primary} />
                            <Text style={styles.permissionItemText}>ÎßàÏù¥ÌÅ¨ - Ïò§ÎîîÏò§ ÎÖπÏùå</Text>
                        </View>
                        <View style={styles.permissionItem}>
                            <Ionicons name="save" size={20} color={colors.primary} />
                            <Text style={styles.permissionItemText}>Ï†ÄÏû•ÏÜå - ÏòÅÏÉÅ Ï†ÄÏû•</Text>
                        </View>
                    </View>

                    <TouchableOpacity
                        style={styles.permissionButton}
                        onPress={requestAllPermissions}
                        disabled={isRequestingPermissions}
                    >
                        <LinearGradient
                            colors={[colors.primary, colors.accent]}
                            style={styles.permissionButtonGradient}
                        >
                            <Ionicons
                                name={isRequestingPermissions ? "hourglass" : "shield-checkmark"}
                                size={20}
                                color={colors.surface}
                            />
                            <Text style={styles.permissionButtonText}>
                                {isRequestingPermissions ? 'Í∂åÌïú ÏöîÏ≤≠ Ï§ë...' : 'Í∂åÌïú ÌóàÏö©ÌïòÍ∏∞'}
                            </Text>
                        </LinearGradient>
                    </TouchableOpacity>
                </LinearGradient>
            </View>
        </Animated.View>
    );

    const renderCameraPreview = () => (
        <Animated.View
            style={[
                styles.cameraCard,
                {
                    opacity: fadeAnim,
                    transform: [{ scale: scaleAnim }]
                }
            ]}
        >
            <LinearGradient
                colors={[colors.surface, colors.surfaceAlt]}
                style={styles.cameraCardGradient}
            >
                <View style={styles.cameraPreviewContainer}>
                    <CameraView
                        style={styles.cameraPreview}
                        facing={cameraType}
                    >
                        {/* Ïπ¥Î©îÎùº Ïò§Î≤ÑÎ†àÏù¥ */}
                        <View style={styles.cameraOverlay}>
                            {/* ÏÉÅÌÉú ÌëúÏãú */}
                            <View style={styles.cameraStatusContainer}>
                                <LinearGradient
                                    colors={['rgba(0,0,0,0.8)', 'rgba(0,0,0,0.4)']}
                                    style={styles.statusGradient}
                                >
                                    <View style={styles.statusIndicator}>
                                        <View style={[styles.statusDot, { backgroundColor: colors.success }]} />
                                        <Text style={styles.statusText}>ÎùºÏù¥Î∏å</Text>
                                    </View>
                                </LinearGradient>
                            </View>

                            {/* Ïπ¥Î©îÎùº Ï†ÑÌôò Î≤ÑÌäº */}
                            <TouchableOpacity
                                style={styles.cameraControlButton}
                                onPress={toggleCameraType}
                            >
                                <LinearGradient
                                    colors={['rgba(255,255,255,0.9)', 'rgba(255,255,255,0.7)']}
                                    style={styles.controlButtonGradient}
                                >
                                    <Ionicons name="camera-reverse" size={24} color={colors.text} />
                                </LinearGradient>
                            </TouchableOpacity>
                        </View>
                    </CameraView>
                </View>

                <View style={styles.cameraInfo}>
                    <Text style={styles.cameraTitle}>üìπ {cameraName}</Text>
                    <Text style={styles.cameraSubtitle}>
                        {isStreaming ? 'üî¥ ÏÜ°Ï∂ú Ï§ë' : '‚ö´ ÎåÄÍ∏∞ Ï§ë'}
                    </Text>
                </View>
            </LinearGradient>
        </Animated.View>
    );

    const renderConnectionCard = () => (
        <Animated.View
            style={[
                styles.connectionCard,
                {
                    opacity: fadeAnim,
                    transform: [{ translateY: slideAnim }]
                }
            ]}
        >
            <LinearGradient
                colors={[colors.surface, colors.surfaceAlt]}
                style={styles.connectionCardGradient}
            >
                <View style={styles.connectionHeader}>
                    <View style={styles.connectionIconContainer}>
                        <LinearGradient
                            colors={[colors.primary, colors.accent]}
                            style={styles.connectionIconGradient}
                        >
                            <Ionicons name="wifi" size={24} color={colors.surface} />
                        </LinearGradient>
                    </View>
                    <View style={styles.connectionTitleContainer}>
                        <Text style={styles.connectionTitle}>Ïó∞Í≤∞ ÏÉÅÌÉú</Text>
                        <Text style={styles.connectionSubtitle}>
                            {connectionState.isConnected ? 'ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Îê®' : 'Ïó∞Í≤∞ ÌôïÏù∏ Ï§ë...'}
                        </Text>
                    </View>
                    <View style={[
                        styles.connectionIndicator,
                        { backgroundColor: connectionState.isConnected ? colors.success : colors.warning }
                    ]} />
                </View>

                {/* PIN ÏΩîÎìú ÌëúÏãú ÏòÅÏó≠ */}
                {pinCode && (
                    <Animated.View
                        style={[
                            styles.pinCodeSection,
                            { transform: [{ scale: pinPulseAnim }] }
                        ]}
                    >
                        <View style={styles.pinCodeHeader}>
                            <Ionicons name="key" size={20} color={colors.primary} />
                            <Text style={styles.pinCodeLabel}>Ïó∞Í≤∞ PIN ÏΩîÎìú</Text>
                        </View>

                        <View style={styles.pinCodeDisplayContainer}>
                            <LinearGradient
                                colors={[colors.primary + '10', colors.accent + '10']}
                                style={styles.pinCodeDisplayGradient}
                            >
                                <Text style={styles.pinCodeText}>{pinCode}</Text>
                                <TouchableOpacity
                                    style={styles.pinCodeCopyButton}
                                    onPress={async () => {
                                        try {
                                            await Clipboard.setStringAsync(pinCode);
                                            Alert.alert("Î≥µÏÇ¨Îê®", "PIN ÏΩîÎìúÍ∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.");
                                        } catch (error) {
                                            Alert.alert("Ïò§Î•ò", "Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
                                        }
                                    }}
                                >
                                    <Ionicons name="copy" size={18} color={colors.primary} />
                                </TouchableOpacity>
                            </LinearGradient>
                        </View>

                        <Text style={styles.pinCodeExpiry}>‚è∞ 10Î∂ÑÍ∞Ñ Ïú†Ìö®</Text>
                    </Animated.View>
                )}

                {/* Ïó∞Í≤∞ Î≤ÑÌäº */}
                <TouchableOpacity
                    style={styles.generatePinButton}
                    onPress={handleGeneratePinCode}
                >
                    <LinearGradient
                        colors={pinCode ? [colors.accent, colors.primary] : [colors.primary, colors.accent]}
                        style={styles.generatePinButtonGradient}
                    >
                        <Ionicons
                            name={pinCode ? "refresh" : "key"}
                            size={20}
                            color={colors.surface}
                        />
                        <Text style={styles.generatePinButtonText}>
                            {pinCode ? 'PIN ÏΩîÎìú Ïû¨ÏÉùÏÑ±' : 'Î∑∞Ïñ¥ Ïó∞Í≤∞ÌïòÍ∏∞'}
                        </Text>
                    </LinearGradient>
                </TouchableOpacity>
            </LinearGradient>
        </Animated.View>
    );

    const renderControlsCard = () => (
        <Animated.View
            style={[
                styles.controlsCard,
                {
                    opacity: fadeAnim,
                    transform: [{ translateY: slideAnim }]
                }
            ]}
        >
            <LinearGradient
                colors={[colors.surface, colors.surfaceAlt]}
                style={styles.controlsCardGradient}
            >
                <Text style={styles.controlsTitle}>üì° Î∞©ÏÜ° Ï†úÏñ¥</Text>

                <View style={styles.controlsRow}>
                    {/* Ïä§Ìä∏Î¶¨Î∞ç ÌÜ†Í∏Ä Î≤ÑÌäº */}
                    <TouchableOpacity
                        style={[styles.streamingButton, isStreaming && styles.streamingButtonActive]}
                        onPress={handleToggleStreaming}
                    >
                        <LinearGradient
                            colors={isStreaming ? [colors.error, colors.warning] : [colors.success, colors.primary]}
                            style={styles.streamingButtonGradient}
                        >
                            <Ionicons
                                name={isStreaming ? "stop-circle" : "play-circle"}
                                size={28}
                                color={colors.surface}
                            />
                            <Text style={styles.streamingButtonText}>
                                {isStreaming ? 'ÏÜ°Ï∂ú Ï§ëÏßÄ' : 'ÏÜ°Ï∂ú ÏãúÏûë'}
                            </Text>
                        </LinearGradient>
                    </TouchableOpacity>

                    {/* ÏÑ§Ï†ï Î≤ÑÌäº */}
                    <TouchableOpacity
                        style={styles.settingsControlButton}
                        onPress={handleSettings}
                    >
                        <LinearGradient
                            colors={[colors.surface, colors.surfaceAlt]}
                            style={styles.settingsControlButtonGradient}
                        >
                            <Ionicons name="settings" size={24} color={colors.text} />
                        </LinearGradient>
                    </TouchableOpacity>
                </View>
            </LinearGradient>
        </Animated.View>
    );

    return (
        <>
            <StatusBar barStyle="dark-content" backgroundColor={colors.background} />
            <View style={styles.container}>
                <LinearGradient
                    colors={[colors.background, colors.surfaceAlt]}
                    style={styles.backgroundGradient}
                />

                <SafeAreaView style={styles.safeArea}>
                    {/* Header */}
                    <Animated.View
                        style={[
                            styles.header,
                            { opacity: fadeAnim, transform: [{ translateY: slideAnim }] }
                        ]}
                    >
                        <View style={styles.headerLeft}>
                            <LinearGradient
                                colors={[colors.primary, colors.accent]}
                                style={styles.headerIconGradient}
                            >
                                <Ionicons name="videocam" size={24} color={colors.surface} />
                            </LinearGradient>
                        </View>

                        <View style={styles.headerCenter}>
                            <Text style={styles.headerTitle}>ÌôàÏ∫† Î™®Îìú</Text>
                            <Text style={styles.headerSubtitle}>Ïã§ÏãúÍ∞Ñ Î∞©ÏÜ° Ï§ÄÎπÑ</Text>
                        </View>

                        <TouchableOpacity
                            style={styles.headerSettingsButton}
                            onPress={handleSettings}
                        >
                            <LinearGradient
                                colors={[colors.surface, colors.surfaceAlt]}
                                style={styles.headerSettingsGradient}
                            >
                                <Ionicons name="settings" size={20} color={colors.text} />
                            </LinearGradient>
                        </TouchableOpacity>
                    </Animated.View>

                    <ScrollView
                        style={styles.scrollView}
                        contentContainerStyle={styles.scrollContent}
                        showsVerticalScrollIndicator={false}
                    >
                        {/* Í∂åÌïú ÌôïÏù∏ ÎòêÎäî Î©îÏù∏ ÏΩòÌÖêÏ∏† */}
                        {!hasAllPermissions ? renderPermissionScreen() : (
                            <>
                                {renderCameraPreview()}
                                {renderConnectionCard()}
                                {renderControlsCard()}

                                {/* Ïó∞Í≤∞ Ïû¨ÏãúÎèÑ Î≤ÑÌäº */}
                                {!connectionState.isConnected && (
                                    <Animated.View
                                        style={[
                                            styles.retryContainer,
                                            { opacity: fadeAnim, transform: [{ translateY: slideAnim }] }
                                        ]}
                                    >
                                        <View style={styles.retryButtonsRow}>
                                            <TouchableOpacity
                                                style={[styles.retryButton, styles.retryButtonHalf]}
                                                onPress={connectionActions.reconnect}
                                            >
                                                <LinearGradient
                                                    colors={[colors.warning, colors.accent]}
                                                    style={styles.retryButtonGradient}
                                                >
                                                    <Ionicons name="refresh" size={20} color={colors.surface} />
                                                    <Text style={styles.retryButtonText}>Ïû¨Ïó∞Í≤∞</Text>
                                                </LinearGradient>
                                            </TouchableOpacity>

                                            <TouchableOpacity
                                                style={[styles.retryButton, styles.retryButtonHalf]}
                                                onPress={async () => {
                                                    try {
                                                        const ipChanged = await forceRediscover();
                                                        if (ipChanged) {
                                                            Alert.alert('ÏÑúÎ≤Ñ Î∞úÍ≤¨! üéØ', 'ÏÉàÎ°úÏö¥ ÏÑúÎ≤Ñ IPÎ•º Ï∞æÏïòÏäµÎãàÎã§. Îã§Ïãú Ïó∞Í≤∞ÏùÑ ÏãúÎèÑÌï¥Î≥¥ÏÑ∏Ïöî.');
                                                        } else {
                                                            Alert.alert('ÏÑúÎ≤Ñ Í≤ÄÏÉâ ÏôÑÎ£å', 'ÌòÑÏû¨ ÏÑ§Ï†ïÏù¥ ÏµúÏ†ÅÏûÖÎãàÎã§.');
                                                        }
                                                    } catch (error) {
                                                        Alert.alert('Í≤ÄÏÉâ Ïã§Ìå®', 'ÎÑ§Ìä∏ÏõåÌÅ¨ Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                                                    }
                                                }}
                                            >
                                                <LinearGradient
                                                    colors={[colors.primary, colors.success]}
                                                    style={styles.retryButtonGradient}
                                                >
                                                    <Ionicons name="search" size={20} color={colors.surface} />
                                                    <Text style={styles.retryButtonText}>ÏÑúÎ≤Ñ Í≤ÄÏÉâ</Text>
                                                </LinearGradient>
                                            </TouchableOpacity>
                                        </View>
                                    </Animated.View>
                                )}
                            </>
                        )}
                    </ScrollView>
                </SafeAreaView>
            </View>
        </>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
    },
    backgroundGradient: {
        position: 'absolute',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
    },
    safeArea: {
        flex: 1,
    },
    header: {
        flexDirection: "row",
        alignItems: "center",
        justifyContent: "space-between",
        paddingHorizontal: spacing.xl,
        paddingVertical: spacing.lg,
    },
    headerLeft: {
        width: 24,
    },
    headerCenter: {
        flex: 1,
        alignItems: "center",
    },
    headerTitle: {
        ...typography.h2,
        color: colors.text,
        textAlign: "center",
    },
    headerSubtitle: {
        ...typography.body,
        color: colors.textSecondary,
        marginTop: spacing.xs,
    },
    headerSettingsButton: {
        padding: spacing.sm,
        borderRadius: radius.md,
        backgroundColor: colors.surface,
        ...elevation['1'],
    },
    headerIconGradient: {
        width: 40,
        height: 40,
        borderRadius: 20,
        alignItems: "center",
        justifyContent: "center",
    },
    headerSettingsGradient: {
        flexDirection: "row",
        alignItems: "center",
        justifyContent: "center",
        padding: spacing.sm,
        borderRadius: radius.md,
    },
    scrollView: {
        flex: 1,
    },
    scrollContent: {
        paddingHorizontal: spacing.xl,
        paddingBottom: spacing.xl,
    },
    permissionContainer: {
        flex: 1,
        justifyContent: "center",
        alignItems: "center",
        marginBottom: spacing.lg,
    },
    permissionCard: {
        width: "100%",
        borderRadius: radius.lg,
        overflow: "hidden",
        ...elevation['3'],
    },
    permissionCardGradient: {
        padding: spacing.lg,
    },
    permissionIconContainer: {
        width: 120,
        height: 120,
        borderRadius: 60,
        backgroundColor: colors.surface,
        alignItems: "center",
        justifyContent: "center",
        marginBottom: spacing.md,
        ...elevation['2'],
    },
    permissionIconGradient: {
        width: "100%",
        height: "100%",
        borderRadius: 60,
        alignItems: "center",
        justifyContent: "center",
    },
    permissionTitle: {
        ...typography.h2,
        color: colors.text,
        marginBottom: spacing.md,
        textAlign: "center",
    },
    permissionDescription: {
        ...typography.body,
        color: colors.textSecondary,
        textAlign: "center",
        marginBottom: spacing.lg,
        lineHeight: 24,
    },
    permissionList: {
        marginBottom: spacing.lg,
    },
    permissionItem: {
        flexDirection: "row",
        alignItems: "center",
        marginBottom: spacing.xs,
    },
    permissionItemText: {
        ...typography.body,
        color: colors.textSecondary,
        marginLeft: spacing.sm,
    },
    permissionButton: {
        borderRadius: radius.lg,
        overflow: 'hidden',
        ...elevation['2'],
    },
    permissionButtonGradient: {
        paddingVertical: spacing.md,
        paddingHorizontal: spacing.xl,
        alignItems: 'center',
        justifyContent: 'center',
    },
    permissionButtonText: {
        ...typography.bodyLg,
        color: colors.surface,
        fontWeight: '600',
    },
    cameraCard: {
        marginBottom: spacing.lg,
        borderRadius: radius.lg,
        overflow: "hidden",
        ...elevation['3'],
    },
    cameraCardGradient: {
        padding: spacing.lg,
    },
    cameraPreviewContainer: {
        width: "100%",
        height: screenHeight * 0.4,
        borderRadius: radius.xl,
        overflow: "hidden",
        ...elevation['2'],
    },
    cameraPreview: {
        width: "100%",
        height: "100%",
    },
    cameraOverlay: {
        position: 'absolute',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'flex-start',
        padding: spacing.lg,
    },
    cameraStatusContainer: {
        position: 'absolute',
        top: spacing.md,
        left: spacing.md,
        borderRadius: radius.md,
        overflow: 'hidden',
    },
    statusGradient: {
        padding: spacing.sm,
        alignItems: 'center',
        justifyContent: 'center',
    },
    statusIndicator: {
        flexDirection: 'row',
        alignItems: 'center',
    },
    statusDot: {
        width: 8,
        height: 8,
        borderRadius: 4,
        marginRight: spacing.xs,
    },
    statusText: {
        ...typography.caption,
        color: colors.surface,
    },
    cameraControlButton: {
        borderRadius: radius.full,
        padding: spacing.sm,
        alignItems: 'center',
        justifyContent: 'center',
    },
    controlButtonGradient: {
        width: 48,
        height: 48,
        borderRadius: 24,
        alignItems: 'center',
        justifyContent: 'center',
    },
    cameraInfo: {
        marginTop: spacing.md,
        alignItems: "center",
    },
    cameraTitle: {
        ...typography.h3,
        color: colors.text,
        marginBottom: spacing.xs,
    },
    cameraSubtitle: {
        ...typography.body,
        color: colors.textSecondary,
    },
    connectionCard: {
        marginBottom: spacing.lg,
        borderRadius: radius.lg,
        overflow: "hidden",
        ...elevation['3'],
    },
    connectionCardGradient: {
        padding: spacing.lg,
    },
    connectionHeader: {
        flexDirection: 'row',
        alignItems: 'center',
        marginBottom: spacing.md,
    },
    connectionIconContainer: {
        width: 40,
        height: 40,
        borderRadius: 20,
        alignItems: "center",
        justifyContent: "center",
    },
    connectionIconGradient: {
        width: "100%",
        height: "100%",
        borderRadius: 20,
        alignItems: "center",
        justifyContent: "center",
    },
    connectionTitleContainer: {
        flex: 1,
        marginLeft: spacing.sm,
    },
    connectionTitle: {
        ...typography.h3,
        color: colors.text,
    },
    connectionSubtitle: {
        ...typography.body,
        color: colors.textSecondary,
        marginTop: spacing.xs,
    },
    connectionIndicator: {
        width: 8,
        height: 8,
        borderRadius: 4,
        marginLeft: spacing.sm,
    },
    pinCodeSection: {
        marginTop: spacing.md,
        marginBottom: spacing.lg,
    },
    pinCodeHeader: {
        flexDirection: 'row',
        alignItems: 'center',
        marginBottom: spacing.xs,
    },
    pinCodeLabel: {
        ...typography.bodyLg,
        color: colors.textSecondary,
        marginLeft: spacing.sm,
    },
    pinCodeDisplayContainer: {
        borderRadius: radius.md,
        overflow: 'hidden',
        ...elevation['1'],
    },
    pinCodeDisplayGradient: {
        flexDirection: 'row',
        alignItems: 'center',
        paddingVertical: spacing.sm,
        paddingHorizontal: spacing.md,
    },
    pinCodeText: {
        ...typography.bodyLg,
        color: colors.text,
        fontWeight: '600',
        marginRight: spacing.sm,
    },
    pinCodeCopyButton: {
        padding: spacing.sm,
    },
    pinCodeExpiry: {
        ...typography.caption,
        color: colors.textSecondary,
        textAlign: "center",
    },
    generatePinButton: {
        borderRadius: radius.lg,
        overflow: 'hidden',
        ...elevation['1'],
    },
    generatePinButtonGradient: {
        flexDirection: "row",
        alignItems: "center",
        justifyContent: "center",
        paddingVertical: spacing.md,
        paddingHorizontal: spacing.lg,
    },
    generatePinButtonText: {
        ...typography.bodyLg,
        color: colors.surface,
        fontWeight: "600",
        marginLeft: spacing.sm,
    },
    controlsCard: {
        marginBottom: spacing.lg,
        borderRadius: radius.lg,
        overflow: "hidden",
        ...elevation['3'],
    },
    controlsCardGradient: {
        padding: spacing.lg,
    },
    controlsTitle: {
        ...typography.h3,
        color: colors.text,
        marginBottom: spacing.md,
    },
    controlsRow: {
        flexDirection: "row",
        justifyContent: "space-between",
    },
    streamingButton: {
        flex: 1,
        marginRight: spacing.md,
        borderRadius: radius.lg,
        overflow: 'hidden',
        ...elevation['2'],
    },
    streamingButtonActive: {
        // Ïä§ÌÉÄÏùºÏùÄ streamingButtonÍ≥º ÎèôÏùºÌïòÏßÄÎßå ÏÉâÏÉÅÎßå Îã§Î¶Ñ
    },
    streamingButtonGradient: {
        flexDirection: "row",
        alignItems: "center",
        justifyContent: "center",
        paddingVertical: spacing.lg,
        paddingHorizontal: spacing.xl,
    },
    streamingButtonText: {
        ...typography.bodyLg,
        color: colors.surface,
        fontWeight: "600",
        marginLeft: spacing.sm,
    },
    settingsControlButton: {
        padding: spacing.lg,
        backgroundColor: colors.surface,
        borderRadius: radius.lg,
        ...elevation['1'],
    },
    settingsControlButtonGradient: {
        width: "100%",
        height: "100%",
        borderRadius: radius.lg,
        alignItems: "center",
        justifyContent: "center",
    },
    retryContainer: {
        marginTop: spacing.lg,
        alignItems: "center",
    },
    retryButtonsRow: {
        flexDirection: "row",
        gap: spacing.md,
        width: "100%",
    },
    retryButton: {
        paddingVertical: spacing.md,
        paddingHorizontal: spacing.xl,
        backgroundColor: colors.primary,
        borderRadius: radius.lg,
        alignItems: "center",
        justifyContent: "center",
        ...elevation['1'],
    },
    retryButtonHalf: {
        flex: 1,
        paddingHorizontal: spacing.md,
    },
    retryButtonGradient: {
        flexDirection: "row",
        alignItems: "center",
        justifyContent: "center",
        paddingVertical: spacing.md,
        paddingHorizontal: spacing.lg,
    },
    retryButtonText: {
        ...typography.bodyLg,
        color: colors.surface,
        fontWeight: "600",
        marginLeft: spacing.sm,
    },
});
